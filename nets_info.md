**Топология сети** - это схема соединения компьютеров в сети.
Представляется в виде графа, где:
Узлы - это вершины (Узлами называют копьютеры и сетевое оборудование).
Рёбра - связь между узлами.

Различают следующие виды топологии:
Полносвязная
Ячеистая (как полносвязная, но некоторые связи удалены)
Звезда (все узлы связаны с центральным устройством)
Кольцо
Дерево
Общая шина
Смешанная топология

# Виды топологии
**Физическая топология** - соединения устройств в сети.
**Логическая топология** - правила распространения сигналов в сети.

Примеры:
классический **Ethernet** имеет физическую топологию **звездв**, поскольку компьютеры подключаются к центральному узлу, но логическую топологию **общая шина**, потому что данные, поступающие на один порт концентратора распространяются на все доступные порты и доступно всем компьютерам в сети.
Коммутируемый **Ethernet** имеет такую же физическую топологию, но логически - **полносвязную**: каждый компьютер может быть соединён напрямую с другим компьютером.
Технология **Wi-Fi** не имеет физическую топологию, а логическую топологию - **общая шина**. Всё, что узел передаёт в радиоэфир доступно всем другим компьютерам, находящимся в зоне действия отправителя.

# Виды стандартов в компьютерных сетях
**De jure** (формальные, юридические) - принятые по формальным законам стандартизации.
Примеры:
ISO (эталонная модель взаимодействия открытых систем),
IEEE (технологии передачи данных, сетевое оборудование),
IAB (протоколы интернет),
W3C (стандарты Web).
Доступны здесь: **https://www.w3.org/standards/**
**De facto** (фактические) - установившиеся сами собой (новые технологии, пользующиеся большой популярностью).

Нас интересует **Internet Engineering Task Force, IETF**, выпускающий стандарты на сетевые протоколы.
он пишет **Request for comments (RFC)** - запросы на комментарии. Содержат в себе:
Документы с описанием работы протоколов
(Формально не называются стандартами (запрос комментариев), но по сути являются таковыми.
Примеры документов:
RFC 791 - протокол IP
RFC 793 - протокол TCP
https://tools.ietf.org/rfc/index

#Основы организации компьютерных сетей

h1. Сложности построения сетей:
Многообразие оборудования и ПО
Надёжность
Развитие сети
Распределение ресурсов
Качество обслуживания
Безопасность

h1. Решение:
Декомпозиция на отдельные подзадачи
Каждый уровень решает одну конкретную задачу или набор связанных задач
Изоляция работ различных уровней

Набор необходимых понятий:
**Сервис** - описывает функционал уровня
**Интерфейс** - набор примитивных операций, которые нижний уровень предоставляет верхнему
Использует реальное взаимодействие внутри компьютера
(Уровень N вызывает уровень N - 1 внутри одного компьютера)
**Протокол** - правила и соглашения, используемые для связи уровня N одного компьютера с уровнем N другого компьютера.
Использует виртуальное взаимодействие между компьютерами
(Реально соединяются друг с другом только уровни, работающие с физической средой)
Виртуальное взаимодействие происходит через заголовки протокола.

**Кратко:**<br>
Сервис - что делает уровень.<br>
Протокол - как уровень это делает.<br>
Интерфейс - как получить доступ к сервису уровня.<br>

**Архитектура сети**:
задаёт набор уровней и протоколов сети.
(Интерфейсы в архитектуру не входят, т. к. могут быть разные на разных программно-аппаратных платформах)

**Стек протоколов** - это иерархически организованный набор протоколов, достаточный для организации взаимодействия по сети.

**Инкапсуляция** - включение сообщения вышестоящего уровня в сообщение нижестоящего уровня.
Сообщение строится по типу: заголовок + данные + концевик (необязательный).

#Модель OSI
Это одна из эталонных моделей организации сети, решающая вопросы:
* Какие уровни долдны быть в сети?
* Какие функции должны выполняться на каждом уровне?

Модель OSI расшифровывается как Open System Interconnection (Модель взаимодействия открытых систем).

**Открытая система** - система, построенная в соответствии с открытыми спецификациями.
**Открытая спецификация** - общедоступная спецификация, соответствующая стандартам.

**Преимущества открытых систем**
* Возможность строить сети из оборудования разных производителей
* "Безболезненная" замена отдельных компонентов сети
* Лёгкость объединения нескольких сетей

Модель OSI используется в качестве "общего языка" для описания разных сетей
Включает 7 уровней организации сети и их назначение
(Протоколы не включены в модель)

<details>
    <summary>Уровни:</summary>
**Application**
Набор приложений
Единица передаваемых данных:
Сообщение
**Presentation**
Предоставлять данные в том виде, который понятен и отправителю, и получателю.
Обеспечивает согласование синтаксиса и семантики передаваемых данных.
* Форматы представления символов
* Форматы чисел
Шифрование и дешифрование
Examples: TLS, SSL
Единица передаваемых данных:
Сообщение
**Session**
Позволяет устанавливать сеансы связи
Задачи:
Управление диалогом (определяет очерёдность передачи сообщений)
Управление маркерами (предотвращение одновременного выполнения критичной операции, транзакции)
Синхронизация (защита от разрыва сетевого соединения и возможность возобновления передачи при восстановлении соединения)
Единица передаваемых данных:
Сообщение
**Transport**
Обеспечивает передачу данных между процессами на хостах
Единица передаваемых данных:
Сегмент/Дейтаграмма
**Network**
Объединяет сети, построенные на основе разных технологий
Задачи:
создание составной сети
Адресация,
**Маршрутизация** - определение маршрута пересылки пакетов в составной сети.
Единица передаваемых данных:
Пакет
**Data Link**
Передача сообщений: определение начала/конца сообщения в потоке бит
Физическая адресация
Единица передаваемых данных:
Кадр
**Physical**
передача битов по физическому каналу связи
Задача: представление бит информации в виде сигналов, передаваемых по среде
Единица передаваемых данных:
Бит
</details>

На разных уровнях модели OSI работает разное оборудование:
Сетевой - Маршрутизатор
Канальный - Коммутатор, точка доступа
Физический - Концентратор

#Модель TCP/IP
Фактический стандарт (de facto).

Прикладной
Транспортный
Интернет
Сетевых интерфейсов

Есть разновидность, известная как "Пятиуровневая модель OSI + TCP/IP":
Прикладной
Транспортный
Сетевой
Канальный
Физический

Описана у Таненбаума, Уэзеролла в книге "Компьютерные сети".
Считается что эта модель ближе всего к тому, что сейчас используется на практике.

#Физический уровень
**Сервис** - передача потока бит по среде передачи данных.
Не вникает в смысл передаваемой информации.
Единица передачи информации - бит.
**Основная задача** - зпредставить биты информации в виде сигналов, передаваемых по среде.
Различают следующие **характеристики канала связи**:
* **Пропускная способность** (бит/с)
* **Задержка** - за сколько времени сообщение доходит от отправителя до получателя
Совместно пропускная способность и задержка характеризуют **скорость работы канала**.
* **Количество ошибок**

**Типы каналов связи**:
* **Симплексный** - данные можно передавать только в одну сторону
* **Дуплексный** - данные можно передавать в обе стороны
* **Полудуплексный** - данные также можно передавать в обе стороны, но по очереди

**Среды передачи данных**
* Кабель:
Витая пара
Оптоволокно
Провода электропитания 220В и т. д.
* Беспроводные технологии:
Радиоволны
Инфракрасное излучение
* Спутниковые каналы
* Беспроводная оптика (лазеры)

**Особенности беспроводной сети**:
* Сигнал передаётся по нескольким направлениям
* Один и тот же сигнал могут принимать несколько приёмников
* Несколько источников сигнала искажают друг друга и требуют координации работы

Поэтому используемые диапазоны регулируются законодательством:
Пример:
Сотовая связь (GSM) - 900 МГц
Wi-Fi: 2,4 ГГц и 5 ГГц
Но другие приборы также работают на этой частоте. Поэтому роутер, расположенный рядом с микроволновкой - не очень хорошая идея.

Среда передачи данных   Частота возникновения ошибок
Оптические кабели       Очень редко
Медные кабели           Редко
Радиоволны              Часто

**Представление информации** также различается:
В медных проводах используется **кодирование**, т. н. прямоугольные импульсы
0 - отсутствие напряжения, 1 - напряжение, но на практике используются более сложные схемы.
**baseband modulation**

В оптоволокне и беспроводной среде используется **модуляция**, т. н. синусоидальные волны
**passband modulation**

#Физический уровень
**Основная задача** - передача сообщений по каналам связи - кадров (frame)
Также на этом уровне:
* определяется точка начала/конца кадра в потоке бит
* происходит обнаружение и коррекция ошибок

Если на канале связи есть несколько устройств, то здесь также решаются следующие вопросы:
* Адресация
* Согласованный доступ к каналу

Канальный уровень получает с сетевого уровня пакет данных.
Затем он добавляет к нему **Заголовок** и **Концевик**, формируя из пакета таким образом **кадр**.
Затем данное сообщение передаётся по среде передачи данных и поступает на канальный уровень принимающего хоста.
В результате на канальном уровне принимающего хоста расшифровываются Заголовок и Концевик и извлечённый **пакет данных** передаётся выше на сетевой уровень.

##Методы выделения кадров##

**Указатель количества байт**

Например, самый простой способ указать начало и конец кадра: в начале каждого кадра указывать его длину в байтах.
Другой метод - вставка в начало и конец каждого кадра особой последовательности байтов или бит, например:
**Протокол BSC** использует текстовые символы:
* DLE STX - начало кадра (Start of TeXt)
* DLE ETX - конец кадра (End of TeXt)
* Escape последовательность в данных - DLE (Data Link Escape)
**Протоколы HDLC и PPP** используют биты:
* 01111110 - начало и каонец кадра
* В данных после пяти последовательных единиц добавлялся 0 для избежания случайного совпадения в теле сообщения вышеупомянутой комбинации бит
* Получатель, в свою очередь после пяти последовательных единиц игнорировал 0

**bit/byte stuffing** (вставка битов/байтов)

**Средства физического уровня**
Преамбула (классический Ethernet)
* Длина 8 байт
* Первые 7 байт: 10101010
* Последний байт: 10101011 (ограничитель начала кадра)

Передача неиспользуемых символов избыточного кода (Fast Ethernet)
* Начало кадра - пара символы J (11000) и K (10001)
* Конец кадра - символ T (01101)

##Варианты обнаружения и исправления ошибок##
**Обнаружение ошибок:**
* Контрольная сумма
Самый простой способ - просто отбросить кадр с нарушенной контрольной суммой

**Исправление ошибок**
* Коды исправляющие ошибки (с избыточной информацией)
* Позволяют обнаруживать и исправлять ошибки

**Повторная отправка данных**
* Если в кадре обнаружена ошибка, его можно отправить заново
Используется совместно с обнаружением ошибок.
* Повторная отправка кадра, который не дошёл до получателя

Есть два варианта метода повторной отправки:
**Остановка и ожидание**
* Отправитель передаёт кадр и останавливает передачу
* Получатель отправляет подтверждение
* Отправитель передаёт новый кадр
У отправителя есть таймаут, если за время ожидания таймаут истёк и подтверждения не пришло - необходимо отправить кадр повторно.
Такая технология используется в Wi-Fi.

**Скользящее окно**
* Отправитель передаёт несколько кадров один за другим, не дожидаясь подтверждения
* Количество кадров, которое можно отправить, называется **размером окна**
* Получатель подтверждает получение кадров (для последнего полученного сообщения)
* Отправитель передаёт новую порцию кадров
(Используется на транспортном уровне в протоколе TCP)

На практике обнаруживать, исправлять ошибки и осуществлять повторную отправку данных можно на разных уровнях:
* Каналы связи с редкими ошибками (например, кабель, волокно) - на верхних уровнях
* Каналы связи с частыми ошибками (например Wi-Fi) - на канальном уровне

Модель OSI разрабатывалась для каналов связи точка-точка
(последовательные линии связи для соединения больших компьютеров)

Когда получили распространение разделяемые каналы связи, модель пришлось изменить.

Канальный уровень был разделён на два подуровня:

**Подуровень управления логическим каналом (Logical Linc Control, LLC)**
* Отвечает за передачу данных (создание кадров, обработка ошибок и т. д.)
* Общий для разных технологий

**Подуровень управления доступом к среде (Media Access Control, MAC)**
* Совместное использование разделяемой среды
* Адресация
* Специфичный для разных технологий
* Не является обязательным (для формата точка-точка, например)

Также подуровень LLC способен осуществлять:
**Мультиплексирование**
* Передача данных разных протоколов (IP, ARP, ICMP) на уровень MAC (через канальный уровень)

**Управление потоком:**
* Предотвращение "затопления" медленного получателя быстрым отправителем
(Если в сети устройства, работающие с разной скоростью, возможна ситуация, когда более быстрое и мощное устройство начинает передавать огромный и быстрый объём данных медленному получателю, "затапливая" его.

##Согласованный доступ к разделяемому каналу связи##

**Управление доступом**:
* Обеспечение использования канала только одним отправителем в один и тот же момент времени
в противном случае произойдёт **коллизия** (данные искажаются, если несколько компьютеров передают одновременно)

**Методы управления доступом**:
* Рандомизированный - из N компьютеров выбирается один с вероятностью 1/N. (Ethernet, Wi-Fi)
* На основе правил использования. (Token Ring)

#Ethernet#
Две технологии Ethernet:

**Классический Ethernet**
* Разделяемая среда
* Ethernet - Gigabit Ethernet

<details>
    <summary>Уровни:</summary>
Ethernet            10 MB/s     802.3
Fast Ethernet       100 MB/s    802.3u
Gigabit Ethernet    1 Gb/s      802.3z, 802.3ab
</details>

**Коммутируемый Ethernet**
* Точка-точка
* Появился в Fast Ethernet
* Единственный вариант в 10G Ethernet и выше

Почти всё современное оборудование поддерживает обе технологии.

##Классический Ethernet##
Исторически - самый первый.
Общая шина - коаксиальный кабель
К каждому компьютеру подключался т-коннектор, соединяющий его с общей шиной.
Минусы - разрыв в одном месте приводил к повреждению всей сети в целом.

Следующий этап технологии - **hub** или **концентратор**
Устройство для создания сетей Ethernet на основе **витой пары**

Физическая топология - **звезда**.
Логическая топология - **общая шина**, так как сигнал, поступающий на один порт концентратора передаётся на все остальные порты.

Преимущества:
если выйдет из строя кабель или сетевой адаптер - сеть перестаёт работать только на одном компьютере.
На основе цветовой индикации легко найти источник, где нет линка.

**Физический уровень Ethernet**
Технология Ethernet содержит описание передачи сигналов по трём разным типам кабелей:
* Коаксиальный
* Витая пара
* Оптоволокно

**Канальный уровень Ethernet**
* Методы доступа и протоколы, одинаковые для любой среды передачи данных
* В классическом Ethernet смешаны подуровни LLC и MAC

На канальном уровне для передачи данных используются кадры.
Есть три стандарта реализации кадра:
* Экспериментальная реализация Ethernet в Xerox (сейчас почти не используется)
* Ethernet II (Ethernet DIX) - фирменный стандарт Ethernet компаний DEC, Intel, Xerox
* IEEE 802.3 - юридический стандарт Ethernet

Стандарты Ethernet II и IEEE 802.3 незначительно отличаются друг от друга
* Ethernet II используется чаще.

#Формат кадра Ethernet
6 байт      6 байт      2 байта     46-1500 байт    4 байта
Адрес       Адрес       Тип         Данные          Контрольная сумма
получателя  отправителя документа
                        0800 - IPv4
                        86DD - IPv6
                        0806 - ARP
                        etc
Header      Header      Header      Body            Концевик

Поле данные от протокола верхнего уровня:
Максимальная длина 1500 байт,
* Выбрана разработчиками Ethernet
* Ограничение на размер памяти для буфера
* Существует расширение JumboFrame (до 9000 байт)

Минимальная длина 46 байт
* Ограничение технологии Ethernet

#MAC адреса.
Используется на подуровне канального уровня: Media Access Control
Регламентированы стандартом IEEE 802
Наиболее популярны:
Ethernet    (IEEE 802.3)
Wi-Fi       (IEEE 802.11)
**Длина MAC-адреса**
6 байт (48 бит)
**Форма записи** - шесть шестнадцатеричных чисел:
примеры:
* 1C-75-08-D2-49-45
* 1C:75:08:D2:49:45

**Типы MAC-адресов**Ж
1. Индивидуальный (unicast):
* 30-9C-23-15-E8-8C
2. Групповой (multicast, первый бит старшего байта адреса равен 1):
* 01-80-C2-00-00-08
(Передача осуществляется на группу устройств. На этих устройствах должен быть настроен multicast).
3. Широковещательный (broadcast, все 1):
* FF-FF-FF-FF-FF-FF

**Уникальность MAC-адресов**
В одном сегменте сети не должно быть одинаковых MAC-адресов.
* Одна широковещательная среда Ethernet или Wi-Fi
* Один VLAN в коммутируемом Ethernet

Если будет два компьютера с одним MAC-адресом, то один из них не будет работать
* Какой именно не регламентируется

**Способы назначения адресов**
1. Централизованный (по умолчанию) - производителем оборудования согласно стандартам IEEE 802.
2. Локальный - администратором сети, администратор обеспечивает уникальность.

Индикатор способа назначения - второй бит старшего байта MAC-адреса:
- 0 - адрес назначен централизованно
- 1 - адрес назначен локально

Структура централизованного MAC-адреса:
* Первые 3 байта - уникальный идентификатор организации (Organizationally Unique Identifier, OUI), выдаются производителям оборудования.
Примеры:
* 00:00:0C - Cisco
* 00:02:B3 - Intel
* 00:04:AC - IBM
* Последние 3 байта - назначает производитель оборудования, который отвечает за уникальность.

#Классический Ethernet. Метод CSMA/CD.
**Управление доступом к среде** реализуется посредством обеспечения использования канала только одним отправителем.

Классический Ethernet использует для этого метод CSMA/CD:
* Carrier Sense Multiple Access with Collision Detection
* Множественный доступ с прослушиванием несущей частоты и обнаружением коллизий
**Carrier Sense**
Для избежания коллизий, компьютеры передают данные только если среда свободна.
Способ определить, свободна ли среда - прослушивание основной гармоники сигнала (несущей частоты).
**Несущая частота** - основная гармоника сигнала, зависящая от среды передачи данных и используемого протокола передачи данных.
Например, смена тактовой частоты в середине каждого такта при манчестерском кодировании означает, что передача данных уже идёт.
Также может быть случай, когда тактовой частоты нет, но какой-то сигнал есть - это означает что это не сигнал передачи данных, а просто помехи.

**Collision Detection**
Если два компьютера начали передачу одновременно - происходит коллизия.

**Обнаружение коллизий:**
* Компьютер передаёт и принимает сигналы одновременно.
* Если принятый сигнал отличается от переданного - значит возникла коллизия.

Jam-последовательность - передаётся компьютером при обнаружении коллизии для того, чтобы другие компьютеры легче её распознали.
Jam-последовательность - это сигнал, который существенным образом искажает все передаваемые по сети данные, усиливая коллизию чтобы все компьютеры в разделяемой среде поняли, что произошла коллизия и остановили передачу.

В модели CSMA/CD при передаче кадра есть три периода:
1. Период передачи - один из компьютеров передаёт данные в разделяемой среде.
2. Период конкуренции - возникает, когда несколько компьютеров пытаются начать передавать данные.
3. Период простоя - никому данные передавать не нужно, среда свободна.
**Период передачи:**
Если в среде нет несущей частоты, то компьютер может начинать передачу данных.
**Схема передачи:**
Преамбула, Кадр, Межкадровый интервал

**Преамбула** позволяет отправителю и получателю синхронизироваться.
Длина 8 байт
Первые 7 байт: 10101010 - за счёт этого обеспечивается синхронизация отправителя и получателя
Последний байт: 10101011 - две последние единицы - ограничитель начала кадра - знак, что преамбула закончилась.
**Передача кадра**
В классическом Ethernet после окончания преамбулы компьютер начинает передавать кадр.
Все остальные компьютеры в сети начинают принимать кадр и записывают его в свой буфер.
Первые 6 байт кадра содержат адрес получателя:
* Компьютер, который узнал свой адрес, продолжает записывать кадр
* Остальные удаляют кадр из буфера
Есть специальный режим адаптера:
**Неразборчивый режим** (promiscuous mode):
* Адаптер принимает все кадры в сети, независимо от MAC-адреса назначения.
Часто используют для диагностики сети.
**Межкадровый интервал**:
После передачи кадра в классическом Ethernet выдерживается интервал в 9,6 мкс (микросекунд).
Это делается для предотвращения монопольного захвата канала каким-либо одним устройством
и для приведения сетевых адаптеров в исходное состояние и подготовки их к дальнейшим операциями принятия и передачи кадра.

После межкадрового интервала другие компьютеры могут начать конкурировать за передачу: происходит период конкуренции.

В период конкуренции, если компьютер начал передавать данные и обнаружил коллизию, то он делает паузу.
**Длительность паузы:** L * 512 битовых интервалов.
**Битовый интервал** - это время между появлениями двух последовательных битов данных (0,1 мкс в классическом Ethernet)
L случайно выбирается из диапазона [0, 2 в степени N - 1, где N - номер попытки.

Такой алгоритм называется **экспоненциальным** двоичным алгоритмом отсрочки.
Экспоненциальный, поскольку 2 растёт по экспоненте.
Диапазоны L:
* 1 попытка: [0, 1]
* 2 попытка: [0, 3]
* 3 попытка: [0, 7]
* 5 попытка: [0, 31]
* 10 попытка: [0, 1023]
После 10 попыток интервал не увеличивается
После 16 попыток передача прекращается

Экспоненциальный двоичный алгоритм отсрочки хорошо работает при низкой загрузке:
* Когда в сети мало компьютеров
* Когда компьютеры редко передают данные

Если нагрузка высокая, то коллизии возникают чаще:
* Растёт число попыток передачи
* Растёт интервал, из которого выбирается L, и длительность пауз
* Экспоненциально увеличивается задержка
В результате скорость передачи данных по сети существенно снижается.

**Недостатки классического Ethernet**
Плохая масштабируемость:
* Сеть становится неработоспособной при загрузке разделяемой среды больше, чем на 30%
* Работоспособное количество компьютеров - 30

Низкая безопасность:
* Данные в разделяемой среде доступны всем

Разное время доставки кадра:
* Причина - коллизии
* Плохо для трафика реального времени

Решение проблем:
* Коммутируемый Ethernet

**Типы Ethernet**
Классический Ethernet
Исторически появился первый (1973 г.)
Разделяемая среда, коллизии
Метод CSMA/CD

Коммутируемый Ethernet
Новая усовершенствованная технология (1995 г., Fast Ethernet, IEEE 802.3u)
Нет разделяемой среды
Нет коллизий
Новые устройства - коммутаторы (switch)

**Концентратор (Hub)**
имеет топологию - общая шина.
Все порты внутри соединены друг с другом.
Работает на физическом уровне:
передаёт поступающие ему электрические сигналы на все остальные порты.

**Коммутатор (Switch)**
Имеет полносвязную топологию.
Все порты соединены друг с другом на прямую по технологии "точка-точка".
Работает на канальном уровне:
анализирует заголовок канального уровня, извлекает из него адрес получателя и передаёт данные только на тот порт, к которому подключен получатель.

#Особенности работы коммутаторов
**Таблица коммутации**
* Соответствие MAC-адресов портам коммутатора

Для заполнения таблицы MAC-адресов используется
**Алгоритм обратного обучения**
* Заполнение таблицы коммутации

После того, как таблица заполнена для передачи данных используется
**Алгоритм прозрачного моста**
* Передача кадров коммутатором

**Таблица коммутации**
Содержит данные о доступности MAC-адресов через порты коммутатора.
Пример:
Порт коммутатора    MAC-адрес
        1           1C-75-08-D2-49-45
        2           00-02-B3-A7-49-D1
        3           00-04-AC-85-E7-03
В реальности таблица устроена более сложно (тип записи, номер vlan, состояние порта и т. п.)

**Алгоритм обратного обучения**
Коммутатор принимает все кадры, которые приходят на его порты,
извлекает из них заголовок канального уровня,
а оттуда - адрес отправителя.
Т. о. он записывает этот адрес в соответствие с тем портом, откуда он его извлёк.
Так происходит до тех пор, пока коммутатор не заполнит данные обо всех подключенных к его портам устройствах.

**Сетевой мост**
**Мост** - это устройство для объединения нескольких сетей.
Мосты в классическом Ethernet использовались для разделения крупных сетей на несколько маленьких сетей, внутри которых коллизий возникало гораздо меньше.
Мост принимал все кадры из пограничных сетей, но передавал их в другую сеть только если они предназначались для компьютера из другой сети.
* Предшественник коммутатора
Для коммутатора был выбран алгоритм прозрачного моста
**Прозрачный мост**:
* Не заметен для сетевых устройств (нет своего MAC-адреса)
* Не требует настройки
В таком режиме работает коммутатор: является мостом с большим количеством портов, не требует настройки.

**Алгоритм прозрачного моста**
Когда таблица коммутации заполнена, коммутатор принимает кадры, анализирует заголовок канального уровня и извлекает оттуда адрес получателя.
Ищет этот адрес в таблице коммутации и передаёт его в соответствующий адресу порт.

Если пришёл кадр с адресом получателя, которого нет в таблице MAC-адресов, то коммутатор работает как концентратор:
передаёт кадр на все порты, кроме того, откуда он поступил.

Если используется сеть, состоящая только из коммутаторов, то в такой сети коллизии не возникают
Исключения составляют полудуплексные соединения компьютеров к коммутатору. Коллизия может возникнуть, если компьютер и коммутатор одновременно решат передавать данные.

Если к порту коммутатора подключен концентратор, то этот порт подключается к общей разделяемой среде и на нём могут возникать коллизии как в классическом Ethernet.

**Особенности работы коммутаторов**
* Анализируют заголовок канального уровня
* Передают кадр только получателю
* "Изучают" сеть (алгоритм обратного обучения, таблица коммутации)

**Преимущества**
* Высокая производительность и масштабируемость
* Высокая безопасность

#VLAN

Virtual local area network (виртуальная локальная сеть)
Технология разделения единой физической сети на несколько логических сетей, изолированных друг от друга
**Место в модели OSI**
* Канальный уровень
* Коммутаторы

Использование VLAN необходимо для
**изоляции сетей**
* Разные отделы внутри крупной компании
* Разные компании в бизнес-центре и т. д.

**Преимущества изоляции сетей**
* Безопасность
* Распределение нагрузки
* Ограничение широковещательного трафика

В коммутаторах порты часто различаются разными цветами, чтобы различать VLAN, к которому они принадлежат.

Реализация в таблице коммутации - добавление нового атрибута **идентификатор VLAN**:

Порт коммутатора    MAC-адрес           VLAN
        1           1C-75-08-D2-49-45   2
        2           00-02-B3-A7-49-D1   3
        3           00-04-AC-85-E7-03   2
        4           54-BE-F7-88-15-47   3

Даже если компьютер отправителя знает MAC-адрес получателя, коммутатор не передаст данные, поскольку передача запрещена.

При передаче информации от одного коммутатора к другому возникла необходимость передавать в кадре идентификатор VLAN'a, но в классическом кадре места под это нет:

6 байт      6 байт      2 байта     46-1500 байт    4 байта
Адрес       Адрес       Тип         Данные          Контрольная сумма
получателя  отправителя документа
                        0800 - IPv4
                        86DD - IPv6
                        0806 - ARP
                        etc
Header      Header      Header      Body            Концевик

Решение было предложено в стандарте IEEE 802.1Q

6 байт      6 байт      2 байта         2 байта     2 байта     46-1500 байт    4 байта
Адрес       Адрес       Тип             Тег         Тип         Данные          Контрольная сумма
получателя  отправителя стандартного    содержит    код
                        кадра           номер       протокола
                        0x8100 -        VLAN        уровня
                        указатель,                  выше
                        что кадр с
                        VLAN
Header      Header      Header          Body        Body        Body            Концевик

До внедрения этой технологии информация о номере VLAN'a добавлялась и использовалась только коммутаторами.

Реализация стандарта IEEE 802.1Q выглядит следующим образом:
Сетевой адаптер в компьютере генерирует обычный Ethernet-кадр, внутри которого обычный IP-пакет. В поле Тип протокола следующего уровня содержится значение 0x0800.
Коммутатор получает этот кадр, понимает, что он был получен с компьютера, входящего в определённый VLAN.
Коммутатор добавляет служебные поля:
В поле "Тип протокола следующего уровня" 0x800 заменяется на 0x8100,
добавляется тег с идентификатором VLAN'a,
и затем записывается код протокола следующего уровня: 0x0800

Принимающий коммутатор видит тег с идентификатором VLAN'a,
удаляет информацию о номере VLAN и восстанавливает старые значения о протоколе следующего уровня,
пересылает кадр принимающему компьютеру.

**Типы VLAN**
* Нетегированные - номер VLAN в таблице коммутации
Используется внутри одного коммутатора
* Тегированные - номер VLAN в кадре (стандарт IEEE 802.1Q)
Используются если сеть состоит из нескольких коммутаторов

#STP Protocol
При кольцевом соединении коммутаторов возникает широковещательный шторм.

**Протокол связующего (остовного) дерева**
(Spanning Tree Protocol, STP)
позволяет автоматически отключать дублирующие соединения в Ethernet, чтобы в сети не образовалось кольца и широковещательного шторма.
* Связующее (остовное) дерево - подграф без циклов, содержащий все вершины исходного графа.

Протокол STP определен в стандарте IEEE 802.1D

**Преимущества STP**
* Надёжность соединений между коммутаторами.
* Защита от ошибок конфигурации.
Защищает от случайного подключения коммутаторов в кольцевое соединение:
Соединение будет отключено на программном уровне.

**Этапы работы протокола**
Протокол STP работает в 3 этапа:
1. Выбор корневого коммутатора
2. Определение кратчайших путей до корневого коммутатора
3. Отключение всех остальных соединений

Для реализация STP коммутаторы каждые 2 секунды отправляют управляющие сообщения Bridge Protocol Data Units (BPDU) на групповой адрес STP:
* 01:80:C2:00:00:00.

**Выбор корневого коммутатора**
Выбор происходит по идентификатору коммутатора: выбирается минимальный.
По умолчанию в качестве идентификатора используется MAC-адрес коммутатора.
Но можно повлиять на выбор вручную, чтобы выбрать в качестве корневого коммутатора самый мощный.

На первом этапе коммутаторы не знают друг о друге и каждый считает себя корневым и рассылает всем связанным коммутаторам сообщение о том, что он - корневой коммутатор.
Получив сообщения от своих соседей, коммутаторы сравнивают BID в сообщении со своим BID (Bridge ID).
На следующем этапе коммутаторы будут рассылать сообщение не со своим BID, а с BID коммутатора, которого они признали корневым.

**Расчёт кратчайших путей**
После выбора корневого коммутатора, все остальные рассчитывают кратчайшие пути до него

Длина пути между коммутаторами определяется двумя параметрами:
* Количество промежуточных коммутаторов
* Скорость соединений

Коммутаторы рассылают на все порты BPDU с минимальным расстоянием до корневого коммутатора:
Предположим, что соединение между коммутаторами 1 Gbit/s. Тогда расстояние между ними согласно стандарту равно четырём:

Скорость соединения     Стоимость соединения в STP IEEE 802.1D
    4 Mbit/s                            250
    10 Mbit/s                           100
    16 Mbit/s                           62
    100 Mbit/s                          19
    1 Gbit/s                            4
    2 Gbit/s                            3
    10 Gbit/s                           2

1. Коммутаторы, непосредственно подключённые к корневому коммутатору, определяют скорость соединения с этим коммутатором и выбирают соответствующее значение расстояния.
2. Затем это кратчайшее расстояние рассылается следующим непосредственно подключённым коммутаторам.
3. Они берут это значение, определяют скорость соединения с коммутаторами, передавшими им это значение и определяют суммарное расстояние.
Так мы узнаём расстояние от всех портов до корневого коммутатора.

**Отключение лишних соединений**
Если есть кольцевое соединение, то одно из соединений отключается на этом этапе по следующей логике:
отключается либо соединение, имеющее наибольшее расстояние,
либо отключается тот порт, который имеет наибольшее значение порта.

В этот момент образуется связующее дерево, циклов нет.
При этом если одно из соединений разорвётся, то выключенное соединение снова начнёт работать, как имеющее наименьшее расстояние.

Если мы используем протокол STP, то при подключении устройства к коммутатору нельзя сразу же начинать передавать данные, потому что на новом соединении может оказаться коммутатор и отправка сообщения может привести к созданию кольца и широковещательному шторму.
Для того, чтобы избежать этого, в протоколе STP используются несколько режимов работы портов.

**Состояние портов в STP**
**Listening** - порт обрабатывает BPDU, но не передаёт данные. Начальная стадия подключения.
**Learning** - порт не передаёт кадры, но изучает MAC-адреса в поступающих кадрах и формирует таблицу коммутации. Это второй этап.
**Forwarding** - порт принимает и передаёт кадры данных и BPDU.
**Blocking** - порт заблокирован на программном уровне, чтобы избежать кольцевого соединения.
**Disabled** - порт выключен администратором.

Переход от состояния Listening до Forwarding занимал около 30 секунд в 80-ых годах.
Достаточно долго для современных крупных и часто меняющихся сетей.

**Расширения протокола STP**
RSTP (Rapid Spanning Tree Protocol):
* Улучшенная версия STP
* Срабатывает быстрее при подключении оборудования и изменении конфигурации сети
* Стандарт IEEE 802.1w

**STP и VLAN**
По умолчанию протокол STP не учитывает технологию VLAN:
вы можете создать несколько соединений между коммутаторами, которые будут принадлежать разным VLAN'ам, но Spanning Tree в исходном варианте ничего не знает про VLAN'ы, поэтому часть соединений будет отключена.
Для того, чтобы использовать протокол Spanning Tree с технологией VLAN, необходимо, чтобы остовное дерево строилось для каждого VLAN'a отдельно.
Эту возможность реализовали в стандарте IEEE 802.1s:
* Multiple Spanning Tree Protocol (MSTP), IEEE 802.1s
* Отдельное связующее дерево для каждого VLAN

#Wi-Fi
Wi-Fi - доминирующая технология беспроводной передачи данных в локальных сетях.
Торговая марка, принадлежит компании Wi-Fi Alliance.
Технология Wi-Fi описана в стандартах серии IEEE 802.11.

Ранний вариант расшифровки:
"Wireless Fidelity" - беспроводная точность.
Но сейчас считается, что это игра слов с Hi-Fi - высокая точность.

Для того, чтобы производитель мог назвать своё оборудование Wi-Fi, он должен сдать его на проверку в компанию Wi-Fi Alliance.
Wi-Fi Alliance проверяет оборудование на совместимость со стандартом.
* Только после проверки можно использовать символ Wi-Fi
* Для Ethernet такая проверка не производится.

В модели OSI Wi-Fi находится на физическом и канальном уровне.
В канальном уровне используются два подуровня (Logical Link Control, Media Access Control)

Wi-Fi может работать в двух режимах:
* Инфраструктурный
Характеризуется наличием беспроводного оборудования, т. н. точки доступа, которые подключаются к проводной сети и затем к интернету.
* Одноранговая сеть
Компьютеры взаимодействуют без точек доступа напрямую друг с другом.

**Технология Wi-Fi очень похожа на Ethernet**

Можно сказать, что это Ethernet, адаптированный к беспроводной среде:
Адресация:
* MAC-адреса.
Для передачи данных разделяемая среда:
* Радиоэфир.
И у Wi-Fi и у Ethernet общий формат кадра уровня LLC:
* Стандарт IEEE 802.2
Хотя в процессе передачи по беспроводной среде на уровне MAC Wi-Fi используется другой формат кадра.

**Стандарты физического уровня Wi-Fi**
Название            Год принятия    Скорость        Частота
802.11                  1997           1 и 2 Мб/с   2,4 ГГц
802.11a                 1999           54 Мб/с      5 ГГц
802.11b                 1999           11 Мб/с      2,4 ГГц
802.11g                 2003           54 Мб/с      2,4 ГГц
802.11n                 2009           600 Мб/с     2,4 и 5 ГГц
                                       150 Мб/с одна станция
802.11ac                2014           6.77 Гб/с    5 ГГц
                                       1.69 Гб/с одна станция

Wi-Fi использует для передачи данных электромагнитное излучение и радиоэфир:
2,4 ГГц – 802.11, 802.11b, 802.11g, 802.11n
5 ГГц – 802.11a, 802.11n, 802.11ac
Но в первом стандарте 802.11 использовалось инфракрасное излучение.

Диапазон 2,4 и 5 ГГц не требуют лицензирования:
* Можно использовать свободно
* Другие устройства также используют этот диапазон и создают помехи

**Современные стандарты Wi-Fi используют метод OFMD**
Orthogonal Frequency Division Multiplexing (мультиплексирование с ортогональным частотным разделением).

При этом данные передаются параллельно на разных частотах.
В диапазоне 2.4 ГГц для передачи данных используется 14 каналов.
Их частоты:
Канал   Частота (ГГц)
1           2.412
2           2.417
3           2.422
4           2.427
5           2.432
6           2.437
7           2.442
8           2.447
9           2.452
10          2.457
11          2.462
12          2.467
13          2.472
14          2.484

Каналы немного сдвинуты друг относительно друга, но всё равно частично перекрываются.
Таким образом количество Wi-Fi сетей, которые находятся в одном и том же месте, ограничены количеством каналов.
Если в одной и той же области будет работать больше, чем 14 сетей, им не хватит каналов.
Такая ситуация известна как **"Wi-Fi джунгли"** и она довольно часто встречается, например, в жилых домах.

Wi-Fi может использовать каналы разной ширины: 20, 40, 80 или 160 МГц.
* 20 МГц - первые стандарты Wi-Fi
* 40 МГц - 802.11n
* 80 МГц - 802.11ac (поддержка обязательна)
* 160 МГц - 802.11ac (поддержка по желанию)

**Ширина канала** - это разница между минимальной и максимальной частотой, на которые можно передавать данные.
Чем шире канал - тем более качественно мы можем передавать данные и тем выше скорость передачи данных.

В стандарте 802.11n появилась возможность использовать 40 МГц и за счёт этого увеличивать скорость передачи.
Начиная с этого стандарта появилась возможность использовать несколько антенн для передачи и приёма сигнала.
Если у нас есть несколько антенн, то мы можем использовать несколько пространственных потоков.
**Пространственный поток** - сигнал, распространяющийся от одной антенны до другой.
Параллельная передача нескольких пространственных потоков существенно увеличивает скорость передачи данных.
При этом используется специальный метод кодирования сигналов: MIMO - **Multiple Input Multiple Output**.

**Адаптация скорости**
В Ethernet скорость передачи данных фиксирована.

Wi-Fi позволяет менять скорость при разном качестве сигнала:
* Высокое качество - скорость увеличивается
* Низкое качество - скорость уменьшается

Для того, чтобы уменьшить или увеличить скорость Wi-Fi меняет несколько параметров.
Адаптация скорости реализуется за счёт изменения:
* "Ширины" используемых каналов (20 - 160 МГц)
* Методов модуляции (Modulation type: BPSK, QPSK, 16-QAM, 64-QAM, 256-QAM)
* Интервала между сигналами (Guard Interval - интервал данных между символами, которые передаются по Wi-Fi, измеряется в наносекундах 800 ns - 400 ns)

#Wi-Fi. Управление доступом к разделяемой среде
Физический уровень Wi-Fi использует 6 стандартов IEEE 802.11
Канальный уровень Wi-Fi одинаковый для разных стандартов физического уровня.

Wi-Fi использует для передачи данных разделяемую среду - радиоэфир.
В разделяемой среде возможны коллизии.
Чтобы их избежать, необходим метод доступа к среде, который бы обеспечивал, что в один момент времени данные передает только один компьютер.

**Особенности беспроводной среды**
* Вероятность ошибки передачи данных выше, чем в проводной среде
* Мощность передаваемого сигнала намного выше, чем принимаемого
* Ограниченный диапазон распространения сигнала – не все компьютеры в сети получают данные.
Проблема скрытой станции - один компьютер расположен в зоне пересечения действия сразу двух компьютеров, которые друг друга не видят.
Проблема засвеченной станции - один компьютер в зоне действия существующей передачи видит компьютер за этой зоной действия, но не передаёт данные, так как его среда занята.

Так как ошибки при передаче данных возникают часто, то в Wi-Fi на канальном уровне используется подтверждение получения передаваемых данных.
Коллизии в Wi-Fi обнаруживаются по отсутствию подтверждений. 

**Обнаружение коллизий**
**Ethernet**
* Компьютер передаёт и одновременно принимает сигнал. При сравнении сигналов, если они отличаются - произошла коллизия.
* Jam-последовательность для усугубления коллизии

**Wi-Fi**
* Передаваемый сигнал намного мощнее принимаемого
* Проблемы скрытой и засвеченной станции
* Сигнал о коллизии может не дойти до всех компьютеров

Коллизии в Ethernet дёшевы
* Обнаруживаются сразу после возникновения
* Все компьютеры останавливают передачу данных

Коллизия в Wi-Fi обходится очень дорого
* Требуются большие временные затраты на обнаружение:
1. Время передачи кадра
2. Время тайм-аута ожидания подтверждения

Поэтому в Wi-Fi используется метод CSMA/CA - ножественный доступ с прослушиванием несущей частоты с предотвращением коллизий.

**Методы доступа к среде в Ethernet:**
* CSMA/CD - Множественный доступ с прослушиванием несущей частоты и распознаванием коллизий

**Метод доступа к среде в Wi-Fi:**
* CSMA/CA - Множественный доступ с прослушиванием несущей частоты с предотвращением коллизий (Collision Avoidance)

**Модель CSMA/CA**
Также как и в **Ethernet** перед началом передачи данных компьютеры **Wi-Fi** прослушивают несущую частоту.
Если происходит передача данных, то все остальные компьютеры ожидают завершения передачи данных.
В отличие от Ethernet в **Wi-Fi** после **передачи кадра** и **короткого межкадрового интервала** происходит **передача подтверждения (ACK)**.
После этого все компьютеры, которые хотят передавать данные должны выдержать **межкадровый интервал**.
В **Ethernet** после завершения межкадрового интервала начинается период конкуренции.
Но в **Wi-Fi**, так как коллизии обходятся очень дорого, вместо периода конкуренции используется **период молчания**.
Каждый компьютер выбирает разное время для периода молчания. Случайным образом генерируется некоторое число **слотов ожидания**.
**Слот ожидания** - это промежуток времени, в течение которого компьютер ждёт.
Длина слота ожидания разная для различных стандартов физического уровня Wi-Fi.
Количество слотов ожидания выбирается компьютерами случайным образом.
Первым начинает передавать данные тот компьютер, который выбрал меньше всего слотов ожидания.

Однако метод доступа CSMA/CA не решает проблему скрытой и засвеченной станции.

Другой метод доступа к среде в Wi-Fi:
**протокол Multiple Access with Collision Avoidance (MACA).**
Он позволяет решить проблему скрытой и засвеченной станции.
Однако на практике метода CSMA/CA почти всегда достаточно, поэтому поддержка протокола MACA в оборудовании Wi-Fi не обязательна.

**Протокол MACA**
Перед передачей данных компьютер передаёт управляющее сообщение:
* Request To Send (RTS)
* Включает размер сообщения с данными

Принимающий компьютер отвечает сообщением:
* Clear To Send (CTS)
* Также включает размер ожидаемого сообщения

Компьютеры, увидевшие CTS, ждут:
* Время на передачу данных (размер данных в CTS)
* Время на передачу подтверждения

#Wi-Fi формат кадра

Wi-Fi использует два формата кадра на канальном уровне:
* Подуровень LLC
- Здесь формат кадра такой же как и в Ethernet.
* Подуровень MAC
- Здесь формат кадра отличается.
При реальной передаче данных по беспроводной среде используется именно формат кадра уровня MAC IEEE 802.11.
Однако при поступлении на устройство, происходит автоматическое преобразование на уровень LLC либо оборудованием, либо драйвером в формат кадра Ethernet.

**Формат кадра Wi-Fi уровня MAC стандарт IEEE 802.11**
2 байта     2 байта         6 байт  6 байт  6 байт  2 байта     6 байт  0-2304 байт 4 байта
Управление  Длительность    Адрес 1 Адрес 2 Адрес 3 Управление  Адрес 4 Тело        Контрольная
кадром                                              очерёдностью        кадра       сумма

Самое заметное отличие - в кадре Wi-Fi используется 4 MAC-адреса следующего назначения:
Адрес устройства, которое принимает данные из беспроводной среды (Receiver Address)
Адрес устройства, которое передает данные в беспроводную среду (Transmitter address).
Адрес устройства получателя (Destination Address).
Адрес устройства отправителя (Source Address).

Wi-Fi чаще всего используется в инфраструктурном режиме: данные из беспроводной сети передаются в проводную сеть для последующей передачи в Интернет.
В инфраструктурном режиме для передачи данных чаще всего используются три устройства:
1. Наш компьютер
2. Точка доступа
3. Устройство в проводной среде, которое обеспечивает подключение к интернету.

В Wi-Fi адреса называются следующим образом:
DA - Destination address - адрес назначения (получателя)
SA - Source address - адрес источника (отправителя)
RA - Receiver address - устройство, принимающее данные из беспроводной среды
TA - Transmitter address - устройство, передающее данные в беспроводную среду

Начнём от **передачи кадра с нашего устройства в проводную среду и затем в Интернет**.
Проводная сеть, к которой подключается наша сеть Wi-Fi называется **распределительная система.**
Кадр передаётся от нашего компьютера к проводному маршрутизатору, который затем передаёт его в Интернет.
В этом случае в *первом поле* адреса указывается MAC-адрес точки доступа как **Receiver Address**, принимающий из беспроводной среды:
Адрес 1 Адрес 2 Адрес 3
RA      TA/SA   DA
Во втором поле *"Адрес 2"* указывается MAC-адрес компьютера. В этом случае **Transmitter Address** и **Source Address** совпадают: отправитель сам передаёт данные в беспроводную среду.
И третье поле - **Destination Address** - адрес получателя, MAC-адрес проводного устройства, которое передаёт затем наши данные в интернет.

**Когда кадр передаётся в обратном направлении** от проводного устройства через точку доступа к нашему компьютеру,
в качестве *первого адреса* указывается MAC-адрес нашего первого компьютера:
MAC-адрес нашего компьютера используется как MAC-адрес **Destination address** и
как адрес устройства, которое принимает данные из беспроводной среды: **Receiver Address**
Во *втором поле* указывается MAC-адрес точки доступа: **Transmitter Address**
и в *третьем поле* MAC-адрес отправителя: адрес маршрутизатора **(Source Address)**

Адрес 1 Адрес 2 Адрес 3
RA/DA   TA      SA

Если сеть работает в одноранговом режиме, компьютеры передают данные друг другу.
В этом случае адрес получателя **Destination address** всегда совпадает с устройством принимающим данные из беспроводной среды **Receiver address**.
А адрес отправителя **Source Address** с адресом устройства, передающего данные в беспроводную среду **Transmitter Address**.

В третьем адресе указывается идентификатор одноранговой сети BSSID, который генерируется автоматически.

#Беспроводной мост
4 адреса в заголовке Wi-Fi используются очень редко, в ситуации, которая называется беспроводной мост.
Когда есть два устройства, передающих данные друг другу через беспроводную сеть, которая объединяет две проводных сети.

Адрес 1 Адрес 2 Адрес 3 Адрес 4
RA      TA      DA      SA

Адрес проводного устройства-отправителя указывается в 4-ом поле: **Source Address**
Адрес проводного устройства-получателя в третьем поле: **Destination Address**
Точка доступа отправителя во втором поле: **Transmitter Address**
Точка доступа получателя в первом поле: **Receiver Address**

После четвёртого поля адреса, которое не является обязательным, идёт тело кадра.
Размер поля данных в Wi-Fi 2304 байта (в Ethernet размер поля данных 1500 байт).

Если при проверке поля "Контрольная сумма" произошла ошибка, такой кадр отбрасывается.

2 байта     2 байта         6 байт  6 байт  6 байт  2 байта     6 байт  0-2304 байт 4 байта
Управление  Длительность    Адрес 1 Адрес 2 Адрес 3 Управление  Адрес 4 Тело        Контрольная
кадром                                              очерёдностью        кадра       сумма

Поле "Длительность" используется вместе с управляющими кадрами, например, кадрами из протокола доступа MACA и в этом поле указывается на какое время зарезервирован канал передачи данных Wi-Fi.

**Поле "Управление кадром"**
2 бита      2 бита  4 бита  1 бит   1 бит   1 бит   1 бит   1 бит   1 бит   1 бит       1 бит
Версия      тип     Подтип  To      From    MF      RT      Power   MD      Protection  Order
протокола                   DS      DS                      Mgmt            Frame

Поле "Управление кадром" содержит большое количество управляющих флагов.
**Версия протокола** - сейчас используется 0, остальные значения зарезервированы для будущего использования.
**Тип**:
Типы кадров Wi-Fi:
1. **Кадры данных** (передача данных)
2. **Кадры контроля** (control frames). Служебные кадры
* (RTS - Request to Send - запрос на передачу, CTS - готов к передаче, ACK - подтверждение успешной передачи кадра)
3. **Кадры управления** (management frames). Реализация сервисов Wi-Fi (например, ассоциация с точкой доступа).

Затем идут два поля, указывающих направление передачи кадра.
Флаги **To Distribution System**: от проводного компьютера к распределительной системе и
**From Distribution System**: от распределительной системы к проводному компьютеру.

В Wi-Fi ошибки при передаче случаются часто:
по статистике на 2016-ый - 1 ошибка на 1000 байт.
Передавать данные при том, что размер кадра может достигать 2304 байт затруднительно.
Поэтому в Wi-Fi реализована **фрагментация**.
**Фрагментация** - это технология разделения одного кадра на несколько небольших фрагментов для отдельной передачи.
Фрагментация в Wi-Fi позволяет передавать данные, даже если ошибки возникают очень часто.
При этом кадры делятся на отдельные части (фрагменты) и передаются отдельно.
Скорость при этом падает, но данные будут передаваться.

В Wi-Fi для фрагментации используются два поля заголовка:
**Поле MF** (More Fragments)
Поле "Управление очерёдностью", которое в свою очередь состоит из двух подполей:
* Номер последовательности (Sequence Number).
Содержит номер кадра, который разбивается на отдельные небольшие фрагменты.
Для всех фрагментов одного и того же кадра номер последовательности будет одинаковым.
* Номер фрагмента (Fragment Number)

**Поле RT**  говорит о том, что происходит повторная отправка кадра.
Повторная отправка происходит в том случае, если отправитель не получил подтверждения получения кадра.
Однако может сложиться такая ситуация, что получатель отправил подтверждение получения, но оно не дошло до отправителя.
В обоих случаях отправитель устанавливает флаг **RT**.

Следующие два поля используются для управления питанием.
Wi-Fi часто используется в мобильных устройствах
* Очень важно экономить электроэнергию, чтобы продлить срок работы батареи
Технология IEEE 802.11 Power Saving Mode позволяет экономить питание при работе Wi-Fi.

Стандарт IEEE 802.11 PSM
* Режимы работы станции: активный и спящий
* В спящем режиме станция не принимает и не передаёт данные
* Точка доступа записывает кадры для "спящей" станции в буфер
* "Спящая" станция регулярно просыпается и читает все кадры от точки доступа
* Передавать кадры станция может в любое время

Флаг **Power Mgmt** используется станцией для того, чтобы сообщить точке доступа, что станция использует управление питанием и работает в спящем режиме.
Флаг **MD** More Data устанавливается точкой доступа при передаче кадра станции, которая работает в режиме сохранения питания.
При получении кадра, в котором установлен этот флаг, станция узнаёт, что у точки доступа есть ещё кадры и запрашивает их.

Флаг **Protection Frame** - Защита кадра - применяется, чтобы указать используется шифрование или нет.
Флаг **Order** - порядок - говорит о том сохраняется ли порядок сообщений или нет.
На практике кадры всегда принимаются в том же порядке, в котором отправляются.

#Сервисы Wi-Fi

В сервисах Ethernet есть только функционал **передачи данных**.
Для того, чтобы воспользоваться сетью Ethernet, нужно просто подключиться к ней проводом.

С Wi-Fi ситуация другая:
сигналы распространяются не в закрытой среде по проводам, а в открытой среде через радиоэфир.

Поэтому для обеспечения надёжной работы сети, а также защиты передаваемых данных, в Wi-Fi кроме передачи данных используются дополнительные сервисы:
* Ассоциация
Перед тем как передавать данные по беспроводной сети, к ней нужно подключиться.
* Аутентификация
Перед тем, как подключиться к сети, пользователь должен предоставить свои данные и права на пользование данной сетью.
* Передача данных
* Защита информации (шифрование)
Так как данные в беспроводной сети могут быть доступны всем, кто находится в зоне действия передатчика, для защиты данных их нужно шифровать.
* Роуминг

Wi-Fi предоставляет два Набора сервисов:
* Базовый набор сервисов (basic service set).
BSSID - идентификатор базового набора сервисов, MAC-адрес точки доступа.
* Расширенный набор серсивов (extended service set).
SSID - идентификатор набора сервисов в понятном для человека виде, текстовая строка.

BSSID наиболее распространённая.
В своём радиусе действия точка доступа рассылает идентификаторы своего набора сервисов
Basic Service Set Identifier - это просто MAC-адрес точки доступа.
(пример, BSSID: **FA:F0:82:D9:0D:10**)

Кроме этого рассылается идентификатор набора сервисов в понятном для людей виде
Service Set Identifier, тот самый, который мы видим в списке доступных сетей, когда пытаемся подключиться к Wi-Fi.

Сперва необходимо пройти **аутентификацию**. Для этого клиент, желающий подключиться к сети, отправляет ей управляющий кадр специального вида Management Frame с запросом на аутентификацию.
Если этот запрос удовлетворяет условиям точки доступа, она отвечает кадром с положительным ответом.

**Режимы аутентификации**
**Открытая аутентификация**
* Подключение без пароля
Без ограничений, шифрование не используется, все данные могут быть перехвачены.

**Personal**
Единый пароль для всех устройств в сети

**Enterprise**
Отдельные пароли для разных пользователей с применением сервера аутентификации (протоколы RADIUS, LDAP и т. п.)

После успешной аутентификации клиент высылает точке доступа запрос на **Ассоциацию**.
В этом запросе клиент передаёт параметры Wi-Fi, с которыми он может работать.
Если эти параметры подходят точке доступа, она высылает в ответ кадр с успешной ассоциацией.
Когда аутентификация и ассоциация выполнены, клиент может передавать данные через точку доступа.

Следует отметить, что если клиент хочет передавать данные другому клиенту, который также находится в этой сети, данные передаются через точку доступа.
Это реализовано для того, чтобы упорядочить общение в разделяемом эфире.

Возможна более сложная ситуация, когда после успешной ассоциации клиент подключается к сети, но не имеет права передавать данные без дополнительной внешней аутентификации.
Для того, чтобы пройти эту внешнюю аутентификацию как правило используется внешний сервер авторизации.

**Отключение клиента**
Если клиент захотел отключиться от беспроводной сети, он отправляет точке доступа запрос на **деассоциацию** или **деаутентификацию**.
Точка доступа высылает ответ и отключает клиента от сети.
Если клиент вышел из зоны сети, то его данные будут храниться до тех пор, пока он не будет отключен через установленный в сети таймаут.

**Расширенный набор сервисов**
Полезно, когда необходимо создать сеть Wi-Fi на большой территории, которая больше, чем зона действия одной точки доступа.
В этом случае используются несколько точек доступа, которые согласовано работают между собой с помощью внешнего контроллера.
Все эти точки доступа передают единый идентификатор набора сервисов Service Set Identifier в текстовом виде.
Но идентификатор базового набора сервисов - BSSID - у них разный и как правило равен MAC-адресу точки доступа.

Один из полезных сервисов расширенного набора - **роуминг**.
(Roam — бродить, странствовать)
Когда вы подключились к одной точке доступа Wi-Fi, вы можете перейти в зону действия другой точки доступа и продолжать работу.

Реализация следующая:
Вы проходите ассоциацию и аутентификацию с одной точкой доступа.
Информация о вашем устройстве сохраняется не только в точке доступа, но и в контроллере.
Когда вы перемещаетесь из зоны действия одной точки доступа в другую точку доступа, устройство присылает новой точке доступа запрос на реассоциацию.
Точка доступа извлекает информацию о клиенте из контроллера и если всё проходит хорошо, то клиент подключается к этой точке доступа и продолжает работу с сетью с тем же самым идентификатором, но через другую точку доступа.

**Сканирование**
Как клиент узнаёт какие есть точки доступа и сети там, где он находится.
**Пассивное сканирование**
Все точки доступа регулярно рассылают специальный широковещательный кадр с информацией о себе, так называемый **Beacon** frame.
Этот кадр содержит идентификатор сети (SSID: "Name string") и идентификатор набора базовых сервисов (BSSID: default - MAC).
При пассивном сканировании клиент принимает такие кадры от точек доступа и через некоторое время узнаёт о всех сетях.
**Активное сканирование**
Если клиент хочет быстрее получить информацию о доступных сетях, не дожидаясь рассылки широковещательных кадров от точек доступа, клиент может использовать активное сканирование.
Для этого рассылается специальный широковещательный запрос **Probe** к точкам доступа.
Получив такой запрос, точки доступа пересылают информацию о сетях, которые они обслуживают.

**Шифрование**
Информация, которую мы передаём по беспроводной среде доступна всем: ситуация, аналогичная работе концентратора.

**Шифрование в Wi-Fi**
* Установлен флаг Protection Frame (WEP)
Wired Equivalent Privacy - приватность эквивалентная проводному соединению
* Шифруются только данные, но не заголовки.

**Типы шифрования**
* Wired Equivalent Privacy (WEP)
уже не используется, так как его довольно просто взломать
* Wi-Fi Protected Access (WPA)
* Wi-Fi Protected Access 2 (WPA2)
в настоящее время представляет наивысшую защиту

При пользовании общественными сетями следует соблюдать осторожность, поскольку пароли могут не подлежать шифрованию.

#Network layer

Сетевой уровень (network layer) объединяет сети, построенные на основе разных технологий канального уровня:
* Ethernet
* Wi-Fi
* 5G/4G/3G
* MPLS
* ATM, TokenRing, FDDI (устаревшие)

**История создания**
Сетевой уровень - основа Интернета.
Винтон Серф и Роберт Кан
* первые выдвинули идею сетевого уровня в 1974
* их называют "Отцами Интернета"
* получили за эту идею премию Тьюринга
(эквивалентно Нобелевской премии в информационных технологиях и компьютерных науках)

Сетевой уровень необходим, потому что:
* очень много разных, отличающихся друг от друга, технологий канального уровня
* масштабируемость
технологии канального уровня хорошо подходят для локальных сетей, но плохо для глобальных

**Различия сетей**
**Сервис**
* Без гарантии доставки (Ethernet)
* С гарантией доставки (Wi-Fi)
* С гарантией доставки и порядка следования сообщений

**Адресация**
* Ethernet - MAC, Сети сотовой связи - IMEI
* Разный размер, плоская (напр. Ethernet), иерархическая

**Широковещательные**
* Поддерживается или нет

**Максимальный размер кадра (MTU)**
* Ethernet - 1500
* Wi-Fi - 2304

**Формат кадра**
В разных технологиях канального уровня разный формат кадра.

**Согласование различий в сетях**

**Тип сервиса**
Устройство, подтверждающее сети, само посылает подтверждение в Wi-Fi и не ждёт подтверждения от получателя, который работает в Ethernet, не отправляя ему подтверждений также.
* Кадры из Wi-Fi принимаются с отправкой подтверждения, а в Ethernet отправляются без подтверждений

**Адресация**
На сетевом уровне вводятся **глобальные адреса**.
Это адреса устройств в составной сети, которые не зависят от адресов в конкретных технологиях канального уровня.
В таких случаях вводятся два типа адресов: глобальный и локальный.
* Методы преобразования глобального адреса в локальный (ARP для TCP/IP)

**Широковещание**
* Пакеты отправляются всем хостам в сети по индивидуальным адресам

**Фрагментация**
При отправке кадра через сеть мы не можем заранее знать, какой максимальный размер кадра принят на выбранном маршруте.
Для того, чтобы согласовать размер кадра в технологиях канального уровня, на сетевом уровне используется фрагментация.

Устройство, объединяющее сети и принимающее данные, анализирует их размер.
Если передать их за один раз через следующую сеть нельзя, поскольку MTU меньше, чем размер данных, то:
* устройство делит данные на отдельные части - **фрагменты** и передаёт их.
Следующее устройство, объединяющее сети:
* Соединяет эти фрагменты в **пакет**.
* Анализирует размер пакета и MTU следующей сети, через которые будет передавать пакет.

Ethernet - доминирующая технология канального уровня.

Wi-Fi - в некотором смысле адаптация Ethernet для беспроводной среды:
* Формат адресов одинаков
* Формат кадра уровня LLC одинаков (Wi-Fi использует другой формат только на уровне MAC)
* Можно обеспечить согласование Wi-Fi и Ethernet без маршрутизации
(режим моста Wi-Fi маршрутизатора - режим, в котором работа Ethernet и Wi-Fi согласуется на канальном уровне)
* Распределительная система Wi-Fi проводная (сейчас на Ethernet)

Почему нельзя строить сети только на Ethernet?
Ethernet и другие технологии канального уровня не подходят для создания крупной сети, которая может охватить весь мир из-за существенных ограничений по масштабируемости.

**Масштабируемость Ethernet**
**Таблица коммутации**:
* Должна содержать MAC-адреса **всех** хостов в сети
Искать нужный хост в такой таблице будет очень долго.
* Сколько хостов в Интернет?
* Сколько памяти нужно для хранения такой таблицы?
* Как быстро будет осуществляться поиск?

**Отправка пакетов на все порты:**
* Если коммутатор не знает, где находится хост, он отправляет кадр на **все** порты
* Сколько "лишних" кадров будет передаваться в Интернет?

**Отсутствие дублирующих путей между коммутаторами**:
* STP обнаруживает и отключает дублирующие пути
* Активный путь всегда только один

**Масштабируемость на сетевом уровне**
Сетевой уровень работает с блоками адресов.
**Агрегация адресов**:
* Работа не с отдельными адресами, а с блоками адресов
* Блок адресов - сеть

**Запрет пересылки "мусорных" пакетов:**
* Пакет отбрасывается, если нельзя определить, куда его нужно отправлять

**Возможность наличия нескольких активных путей в сети**:
* Одна из основных причин создания сетей с пакетной коммутацией
* Допускается несколько активных путей
* Задача выбора лучшего пути - маршрутизация

**Задачи сетевого уровня:**
* Объединение сетей, построенных на основе разных технологий канального уровня (**internetworking**).
* Маршрутизация - поиск маршрута пакета в крупной составной сети.
* Обеспечение качества обслуживания

Устройство сетевого уровня - маршрутизатор.
**Маршрутизатор** - это устройство для объединения сетей.
У маршрутизатора есть несколько **интерфейсов**. Через эти интерфейсы к маршрутизатору подключаются сети.
У каждого интерфейса на маршрутизаторе есть свой адрес.
(Для сравнения: у интерфейсов коммутаторов своих адресов нет).
Если мы хотим объединить несколько сетей, маршрутизатор необходим.
Нельзя просто подключить две сети напрямую и передавать между ними данные.

**Маршрутизация**
**Маршрутизация** (routing) - это поиск маршрута доставки пакетов данных между сетями через транзитные узлы - маршрутизаторы.
При этом необходимо вести:
* Учёт изменений в топологии сети
* Учёт загрузки каналов связи и маршрутизаторов

**Продвижение** (forwarding) - передача пакета внутри маршрутизатора в соответствии с правилами маршрутизации.

Протоколы сетевого уровня стека TCP/IP:
- IP (Internet Protocol) основной протокол для передачи данных
- ICMP (Internet Control Message Protocol) - используется для управления сетью
- ARP (Address Resolution Protocol) - для определения по глобальному адресу сетевого уровня (ip) определить локальный адрес в технологии канального уровня
- DHCP (Dynamic Host Configuration Protocol) - протокол динамической конфигурации хостов, используется для того, чтобы автоматически назначать ip адреса компьютерам в составной сети.

#IP Addresses

В сетях используются два типа адресов: локальные и глобальные.
**Локальные адреса**:
* Адреса в технологии канального уровня
* Пример: MAC-адрес в Ethernet, IMEI в 4G
* Привязаны к одной технологии
* Не могут быть использованы в гетерогенных сетях
Не могут использоваться для построения крупной составной сети, которая включает в себя сети, использующие разные технологии.

**Глобальные адреса**:
* Адреса сетевого уровня
* Пример: IP адреса
* Не привязаны к технологии
* Применяются при объединении сетей

**IP адреса**
Глобальные адреса, используемые в стеке протоколов TCP/IP.
Используются для уникальной идентификации компьютеров в составной сети. Широко используются в Интернет.

Существует две версии протокола IP:
- IPv4: адрес 4 байта
- IPv6: адрес 16 байт

**Длина адреса IPv4** – 4 байта, 32 бита.
Форма представления: 4 десятичных числа 0-255, разделенных точками.
Для удобства, адрес делят на 4 части по 8 бит. Такую часть называют октет.
Каждый октет записывают в десятичном формате, например:
11010101 10110100 11000001 00000011
    213     180     193     3
213.180.193.3

**IP-адреса и IP-сети**
Сетевой уровень использует агрегацию адресов:
* Масштабирование - работа не с отдельными адресами, а с подсетями.
Подсеть (IP-сеть, сеть, subnet) – множество компьютеров, у которых старшая часть IP-адреса (первые 3 октета) одинаковая.
Примеры:
213.180.193.1
213.180.193.2
213.180.193.3
...
213.180.193.254

Маршрутизаторы работают с подсетями, а не отдельными компьютерами.

**Структура IP-адреса:**
* Номер подсети – старшие биты
* Номер хоста (компьютера в сети) – младшие биты
Пример структуры:
* IP-адрес: 213.180.193.3
* Номер подсети: 213.180.193.0
* Номер хоста: 3 (0.0.0.3)

Маска подсети показывает, где в IP-адресе номер сети, а где хоста.
**Структура маски:**
* Длина 32 бита.
* Единицы в позициях, задающих номер сети.
* Нули в позициях, задающих номер хоста.

Применение логического **AND** маски подсети к IP-адресу даёт адрес подсети.

**Представление маски подсети**.
**Десятичное представление:**
* IP-адрес: 213.180.193.3
* Маска подсети: 255.255.255.0
* Адрес подсети: 213.180.193.0

**Представление в виде префикса:**
Указано сколько первых бит адреса относятся к адресу подсети.
* 213.180.193.3 / 24
* Адрес подсети: 213.180.193.0

Оба представления эквивалентны.

**Маска подсети переменной длины**
Важно понимать, что маска подсети не обязательно должна заканчиваться на границе октетов.

213.180.193.3 /20
IP:         11010101.10110100.11000001.00000011
                         AND
MASK:       11111111.11111111.11110000.00000000
Subnet:     11010101.10110100.11000000.00000000
Subnet
(decimal):  213.180.192.0
Host
(decimal):  0.0.1.3
Адрес хоста включает в себя все незанятые подсетью биты.

**Устаревший метод классов IP-адресов**
Диапазоны жёстко заданы, класс определяется по первым битам.

Класс A (в бинарном виде начинаются на 0)
1.0.0.0 - 126.0.0.0
К адресу сети относится первый октет.
Класс B (в бинарном виде начинается на 10)
128.0.0.0 - 191.255.0.0
К адресу сети относятся первые 16 бит.
Класс C (110)
192.0.0.0 - 223.255.255.0
Наиболее распространённый класс для сетей, включающих в себя до 254 компьютеров.
Класс D - групповые адреса
224.0.0.0 - 239.255.255.255
Класс E - зарезервирован для будущего использования
240.0.0.0 - 255.255.255.255

**Типы IP-адресов:**
* Индивидуальный (unicast)
Адрес конкретного компьютера в сети.
* Групповой (multicast)
Адрес, использующийся несколькими компьютерами.
При отправлении сообщения на этот адрес, его получат несколько компьютеров, входящих в данную группу.
* Широковещательный (broadcast)
Адрес для получения данных всеми компьютерами в сети.

**Широковещательный адрес**
Рассматриваются правила образования широковещательного адреса и два типа широковещания в IP:
* **Направленное широковещание**.
Когда компьютер за пределами нашей сети хочет передать широковещательный пакет всем устройствам в нашей сети.
Широковещательный адрес: ХХХ.ХХХ.Х.255, где Х - адрес подсети.
Пакет передаётся маршрутизатору, маршрутизатор разошлёт этот пакет в широковещательном режиме, но в пределах одной указанной подсети.
* **Ограниченное широковещание**.
Когда мы направляем широковещательный пакет в рамках одной сети.
Широковещательный адрес: 255.255.255.255
Данные получают все компьютеры в сети, а через маршрутизатор данные не пройдут.

**Формат широковещательного адреса**:
* В номере хоста все единицы
* IP-адрес: 213.120.193.3 / 24
* Широковещательный адрес: 213.180.193.255

В IP широковещательные пакеты передаются только внутри подсети (ограниченное широковещание)
* Маршрутизаторы не пересылают широковещательные пакеты
* Нет возможности указать в адресе "все компьютеры в Интернет" (пакет "Godzillagram")

**Специальные IP-адреса**
В номере хоста нельзя использовать только битовые 0 или 1.

Битовые 0 в номере хоста - это адрес подсети.
* Адрес подсети: 213.180.193.0

Битовые 1 в номере хоста - это широковещательный адрес.
* Широковещательный адрес: 213.180.193.255

Договорённость (не обязательная):
часто хост с номером один - это маршрутизатор или шлюз, через который все компьютеры в сети попадают в интернет.
* Хост с номером 1 - маршрутизатор по умолчанию (шлюз):
213.180.193.1

0.0.0.0 - адрес текущего хоста (подсеть), используется когда компьютер ещё не получил свой IP-адрес.
255.255.255.255 - все хосты в текущей подсети (ограниченный широковещательный адрес)

127.0.0.0/8 - обратная петля (loopback)
Специальный диапазон адресов, выделенный для отладки сетевых приложений.
* Сеть для тестирования
* Данные не передаются в сеть, а приходят обратно
* 127.0.0.1 - localhost (текущий компьютер)

169.254.0.0/16 - Link-local адреса
* Назначаются ОС хоста автоматически, если недоступна другая конфигурация IP
(Если не настроен IP-адрес на компьютере вручную или иным способом (например, протокол DHCP))/
* Могут использоваться в пределах подсети
* Не проходят через маршрутизатор

**Распределение IP-адресов**
Все IP-адреса в интернет должны быть уникальными.
Поэтому нельзя использовать любые адреса, нужно получать разрешение у **Internet Assigned Numbers Authority (IANA)**.
Сейчас эту роль выполняет корпорация **ICANN (Internet Corporation for Assigned Names and Numbers).** https://www.icann.org
Однако делает она это не напрямую, а с помощью национальных регистраторов.
Региональные регистраторы (RIR - Regional Internet Register)
В каждом регионе есть свой регистратор, взаимодействующий с корпорацией ICANN.

**Частные IP-адреса**
Однако часто бывают случаи, когда вы создаёте сеть, которая использует IP-адреса, но при этом она не подключена к интернету.
Например, внутренняя сеть организации или внутренняя сеть класса, в которой вы просто тестируете какие-то технологии.
Для этого случая выделены зарезервированные диапазоны адресов (RFC 1918), которые можно использовать без обращения в ICANN:
* 10.0.0.0 /8
* 172.16.0.0 /12
* 192.168.0.0 /16
Эти адреса не маршрутизируются в интернет.
Могут использоваться внутри организации без обращения в IANA
Однако есть возможность подключить сеть, построенную на основе частных адресов, к Интернет.
Для этого используется технология **NAT (Network Address Translation).**

**Исчерпание IP-адресов**
Длина IPv4 адреса 32 бита.
* Максимум 4 294 967 296 (2 в 32 степени) IP-адресов.
Этого было достаточно во времена разработки протокола IP, но не сейчас. В настоящее время почти все адреса IPv4 распределены и получить новый не реально.

**Пути решения**:
* Переход на IPv6 (длина адреса 16 байт)
* Использование технологии NAT
В основном используются частные сети, но выход в интернет происходит через один хост, использующий динамическую трансляцию адресов.

# Internet Protocol

**IP (Internet Protocol) - межсетевой протокол**
* internetworking - объединение сетей
* internet - объединённая сеть / subnet - подсеть
* Internet - название самой крупной объединённой сети, построенной по протоколу IP.
**Основа сети Интернет**
И в модели OSI и в модели TCP/IP она находится на сетевом (network) уровне.

**Сервисы IP**
**Передача данных**
* Без гарантии доставки
* Без сохранения порядка следования сообщений

Протокол IP использует передачу данных без установки соединения
(IP-пакет просто отправляется в сеть в надежде, что он дойдёт до получателя)
Если пакет на дошёл, не предпринимается никаких попыток предупредить отправителя или отправить этот пакет снова.
Считается, что ошибка должна быть исправлена протоколами на вышестоящих уровнях.

**Задачи IP**
* Объединение сетей
* Маршрутизация
* Качество обслуживания

**Формат заголовка IP-пакета**
|------------------------------------------------------------
|4 бита |4 бита    | 8 бит       |          16 бит          |
|Номер  |Длина     | Тип         |      Общая длина         |
|версии |заголовка | сервиса     |                          |
|------------------------------------------------------------
|       16 бит                   |3 бита |      13 бит      |
|Идентификатор пакета            |Флаги  |Смещение фрагмента|
|------------------------------------------------------------
|   8 бит          |    8 бит    |      16 бит              |
|   Время жизни    |Тип протокола|  Контрольная сумма       |
|------------------------------------------------------------
|                       32 бита                             |
|                 IP-адрес отправителя                      |
|------------------------------------------------------------
|                       32 бита                             |
|                 IP-адрес получателя                       |
|------------------------------------------------------------
|                 Опции и выравнивание                      |
|                   (не обязательно)                        |
|------------------------------------------------------------

**Версия IP**
Сейчас существует две версии IP: 4 и 6.
IPv4
* Длина IP-адреса 4 байта
* Нехватка IP-адресов
* Используется сейчас
IPv6
* Длина IP-адреса 16 байт
* Вводится в эксплуатацию

**Длина заголовка**
В отличие от Ethernet, заголовок IP-пакета может включать в себя не только обязательные поля, но и дополнительные (опции).
Сюда записывается общая длина как обязательной части, так и опции.

**Тип сервиса** поле используется для обеспечения необходимого качества обслуживания, но сейчас не используется.

**Общая длина**
Общая длина - длина пакета, включая заголовок и данные.
Измеряется в байтах.
Максимальное значение - 65535 байт.
На практике длина выбирается с учётом размера кадра канального уровня
* 1500 байт для Ethernet.

Поля **Идентификатор пакета**, **Флаги** и **Смещение фрагмента** используются для реализации фрагментации.
**Время жизни** - (TTL, Time To Live) - максимальное время, в течение которого пакет может перемещаться по сети.
Введено для предотвращения "бесконечного" продвижения пакетов.

**Единицы измерения:**
* Секунды
(Но сейчас маршрутизаторы передают пакеты много быстрее, чем за секунды)
* Прохождение через маршрутизатор (hop)

**Тип протокола**
Поле предназначено для реализации функции мультиплексирования/демультиплексирования.
То есть передачи с помощью протокола IP данных от разных протоколов следующего уровня.
Код протокола, данные которого передаются:
* TCP - 6
* UDP - 17
* ICMP - 1

**Контрольная сумма** используется для проверки правильности доставки пакета.
Если при проверке контрольной суммы обнаруживается ошибка, то пакет отбрасывается.
Пересчитывается на каждом маршрутизаторе, из-за того, что заголовки меняются (как минимум "Время жизни")

**Опции**
Заголовок IP-пакета может включать дополнительные поля:
* Записать маршрут
(опция для диагностики сети. В IP-пакет записывается адрес каждого маршрутизатора, через который он проходит).
* Маршрут отправителя
(опции позволяют отказаться от автоматической маршрутизации и задать маршрут отправителя).
1. Жесткая маршрутизация
(явно указан перечень маршрутизаторов).
2. Свободная маршрутизация
(указываются только некоторые маршрутизаторы, через которые должен пройти пакет).
* Временные метки
(опция для диагностики сети. Каждый маршрутизатор записывает время прохождения пакета).

**Заполнение**:
* Опции могут иметь разный размер
* Длина заголовка IP-пакета должна быть кратна 32 битам
Поэтому, при необходимости, для выравнивания до 32 бит поле опций дополняется нулями

#Маршрутизация
**Маршрутизация** – поиск маршрута доставки пакета между сетями через транзитные узлы – маршрутизаторы.

Этапы маршрутизации:
* Изучение сети
* Продвижение (**forwarding**) пакетов на маршрутизаторе
когда сеть уже изучена.
Маршрутизатор определяет в какой из интерфейсов, к которым подключены сети, отправлять пакет.
Дальше маршрутизатор определяет нужно ли передавать пакет в саму сеть или на один из маршрутизаторов, подключённых к этой сети.
Если второй вариант - маршрутизатору необходимо выбрать на какой из маршрутизаторов передать пакет.

Эту информацию маршрутизатор получает из таблицы маршрутизации.
**Таблица маршрутизации**
В упрощённом виде она содержит:
* Адрес сети
* Маска подсети
* Шлюз
Что делать с пакетом, который вышел через заданный интерфейс.
Если состояние "On link", то сеть подключена к маршрутизатору, и пакет нужно передавать в сеть напрямую.
Если пакет нужно передать на следующий маршрутизатор, то в поле "шлюз" указывается адрес этого маршрутизатора.
* Интерфейс
Через какой интерфейс маршрутизатора нужно отправить пакет.
* Метрика.
Сейчас метрика учитывает не только количество маршрутизаторов, но и скорость каналов между сетями и загрузку каналов.

В линукс таблица маршрутизации выглядит иначе.
Основное отличие - идентификаторы интерфейсов.
Вместо IP-адресов используются названия интерфейсов.
Например:
wlan0 - название для беспроводного сетевого интерфейса,
eth0 - название для проводного сетевого интерфейса.

**Записи в таблице маршрутизации**
**Статические**
* Настраиваются вручную
Удобно, если сеть небольшая.
* Конфигурация интерфейсов
* Вручную прописанные маршруты к сетям

**Динамические**
* Настраиваются автоматически
* Протоколы маршрутизации RIP, OSPF, BGP и др.
Сами изучают сеть.
**Преимущества:** изменения в сети обновляются автоматически и учитывают выход из строя одного из маршрутизаторов или появление нового маршрутизатора.

**Маршрут по умолчанию**
Маршрутизатор должен знать обо всех существующих сетях, что на практике невозможно.

Маршрутизатор по умолчанию (шлюз, default router, gateway) - маршрутизатор, на который отправляются пакеты, для которых неизвестен маршрут доставки.
Как правило это маршрутизатор, который подключен к интернет.
Предполагается, что он лучше знает структуру сети.
Условное обозначение:
* 0.0.0.0, маска 0.0.0.0
* default

Destination     Gateway         Genmask         Metric Use Iface
0.0.0.0         10.0.59.9       0.0.0.0         600    0   wlp2s0

**Длина маски подсети**
Рассмотрим ситуацию, при которой маршрутизатор принял пакет с адресом получателя:
* 192.168.100.23

В таблице маршрутизации две записи:
* 192.168.100.0/24
* 192.168.0.0/16

Выбирается та запись, где маска длиннее.
Предполагается, что запись с более длинной маской содержит лучший маршрут интересующей нас сети.
**Правила маршрутизации:**
* Самая длинная маска: 32 - это путь к хосту.
Если в таблице маршрутизации есть такой путь, то выбирается он.
* Поиск маршрута к сети (с маской максимальной длины).
* Маршрут по умолчанию (маска /0, подходят все IP-адреса).

Таблица маршрутизации есть не только у маршрутизаторов, но и у всех хостов в сети.



