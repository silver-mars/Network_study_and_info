# Security
Исторически для защиты от атак создавались жёсткие внешние оболочки (брандмауэры, VPN и т. д.), однако после проникновения внутрь периметра взломщик легко может получить доступ ко многим системам<br>
В istio придумали идею глубокоэшелонированной защиты и применили приёмы сетевой изоляции внутри своего доверительного домена, требуя от администраторов безопасности открывать узкие проходы в сети, достаточные для беспрепятственных взаимодействий наших приложений и не более.<br>

Традиционная сетевая безопасность делает акцент на единственном доступном для сети идентификаторе - IP-адресе. IP-адрес не является сильным индикатором приложения, поскольку разные среды могут повторно использовать IP-адрес для различных рабочих нагрузок.<br>
Для решения этой проблемы в Istio реализована возможность присваивания идентификационных данных каждой рабочей нагрузке в сервисной сетке.<br>
Идентификационные данные привязаны к рабочей нагрузке, а не к конкретному хосту или иной сетевой идентичности.<br>

Это означает, что можно определять политику взаимодействий сервис-сервис, устойчивую к изменениям в топологии и развёртывании системы и не зависящую от конкретных особенностей сети.<br>

**Системы контроля доступа** (access control) отвечают на следующий фундаментальный вопрос: "Может ли сущность совершать действия над объектом?"<br>
**Сущность** - субъект.<br>
**Действие** - операция, определённая системой.<br>
**Объект** - на что воздействует субъект.<br>
Пример: в файловой системе Unix субъект пользователя может совершить действия w, r, x над объектом файл.<br>

**Аутентификация**<br>
Главная цель аутентификации - субъект.<br>
Аутентификация - это процесс получения некоторого удостоверения (например, сертификата), проверки действительности удостоверения (т. е. подлинности удостоверения) и что сущность, представившая удостоверение, действительно является той сущностью, за которую себя выдаёт.<br>

**Аутентификация** - это акт получения удостоверения из запроса и проверки его аутентичности. В Istio роль удостоверения, используемого сервисами при взаимодействии друг с другом, играет  сертификат X509.<br>
Прокси аутентифицируют вызывающую сторону (а вызывающая сторона - отвечающую) проверкой сертификата x509, предоставленного другой стороной.<br>
Если сертификат действителен, то идентичность, закодированная в сертификате, считается аутентифицированной.<br>
После выполнения аутентификации мы говорим, что объект аутентифицирован, называя его **аутентифицированным субъектом**, чтобы отличить его от субъекта, который может быть не аутентифицирован.<br>

**Авторизация** - это акт ответа на вопрос: "Имеет ли право данная сущность выполнить действие над объектом?". Например, прежде чем запустить процесс, система Unix проверяет - имеет ли право текущий пользователь **(аутентифицированный субъект)** выполнить его.<br>
В Istio авторизация сервисов настраивается с помощью политик RBAC.<br>

# Идентичность
Сервисные сетки могут охватывать несколько кластеров.<br>
Сервисы внутри сетки и вне её способны взаимодействовать друг с другом.<br>
Что назвать границей сервисной сетки?<br>

Обычно ответы ограничиваются концепцией **административного домена**, при этом административным доменом являются либо всё, что настраивается одним оператором сервисом, либо всё, что может взаимодействовать друг с другом в рамках одной и той же сетки.<br>
Мы считаем, что лучшим ответом будет:<br>
**"Сервисная сетка - это единый домен идентификации".**<br>
Другими словами, это **единое пространство имён**, из которого каждому сервису в системе присваивается **идентификатор**.<br>
**Идентификация** формирует границу сервисной сетки.<br>
Идентификация является фундаментальной функцией сервисной сетки в том смысле, что все коммуникации исходят из неё.<br>
Управление трафиком и телеметрические функции сервисной сетки зависят от понимания того, как идентифицировать сервисы.<br>

# SPIFFE
Для создания идентификационных данных Istio использует спецификацию Secure Production Identity Framework for Everyone (SPIFFE).<br>
Короче говоря, Istio создаёт сертификат X509, содержащий в поле альтернативного имени субъекта (SAN) URI, описывающий сервис.<br>
Istio обращается к платформе за атрибутами идентичности.<br>
В Kubernetes Istio использует учётную запись сервиса в поде и встраивает её в URI:
```
spiffe://ClusterName/ns/Namespace/sa/ServiceAccountName
```
SPIFFE - это спецификация фреймворка, способного генерировать и выпускать идентификационные данные.<br>
SPIRE (среда выполнения SPIFFE) является эталонной реализацией сообщества SPIFFE, а Citadel является второй реализацией.<br>
Спецификация SPIFEE описывает три понятия:<br>
* идентификаторы в форме URI, используемые сервисами для связи;
* стандарт преобразования этого идентификатора в криптографически проверяемый документ (Verifiable Identity Document SPIFFE, SVID);
* API для выпуска и извлечения SVID (Workload API).

SPIFFE требует, чтобы идентификатор сервиса был закодирован как URI, начинающийся со схемы spiffe. Например:
```
spiffe://trust-domain/path
```
**Доверенный домен** (trust-domain) - это корень доверия идентичности (например, организация, подразделение или команда).<br>
Доверенный домен - это поле полномочий в URI (в частности, часть записи, соответствующая имени хоста).<br>
Спецификация разрешает в разделе пути в URI указывать всё, что угодно - универсальный уникальный идентификатор (UUID), иерархию доверия или вообще ничего не указывать.<br>
В Kubernetes Istio кодирует учётную запись ServiceAccount сервиса, используя имя локального кластера в качестве домена доверия, и создаёт путь, используя имя ServiceAccount и пространство имён.<br>
Например, учётная запись sa по умолчанию закодирована как:
```
spiffe://cluster.local/ns/default/sa/default
```
SPIFFE описывает как преобразовать этот идентификатор в SVID X509.<br>
Сертификат X509 можно проверить, чтобы убедиться в идентичности предъявителя.<br>
Спецификация требует, чтобы идентификатор в форме URI передавался в поле SAN сертификата.<br>
Чтобы убедиться в подлинности SVID, необходимо выполнить три проверки:<br>
1. Обычную проверку X509
2. Подтвердить, что сертификат **не** является сертификатом подписи. Сертификаты подписи не могут использоваться для идентификации в соответствии со спецификацией;
3. Убедиться, что в сертификате присутствует ровно одно поле SAN со схемой SPIFFE.
SPIFFE определяет Workload API для выпуска и извлечения SVID, **однако именно здесь Istio отклоняется от SPIFFE.**<br>
Istio реализует предоставление сертификатов с помощью специального протокола, CA Service.<br>
Citadel Node Agent выпускает CSR через этот API в момент появления новой рабочей нагрузки;<br>
Citadel выполняет проверку запроса и возвращает SVID для рабочей нагрузки.<br>

**И SPIFFE Workload API, и сервис CA преследуют одну и ту же цель:**<br>
подтверждают некоторую информацию о рабочей нагрузке, чтобы получить для неё идентификатор.<br>

Наконец, хотя спецификация SPIFFE и не требует этого, SPIRE и Istio выпускают краткосрочные X509 SVID - они истекают примерно через час после их выпуска.<br>
Это противоречит традиционному использованию сертификатов X509, обычно используемых для инкапсуляции в HTTPS TLS и заканчивающихся через год или более после выпуска.<br>

# Архитектура управления ключами

Citadel, агенты узлов и Envoy - это три ключевых компонента архитектуры управления ключами.<br>
Все они участвуют в выпуске и ротации SVID в сетке Istio:<br>
* **Citadel**<br>
Выдаёт идентификационные данные рабочим нагрузкам в сетке, действуя в качестве CA, подписывая запросы сертификатов, формирующие X509 SVID
* **Агент узла**<br>
Доверенный агент, развёрнутый на каждом узле и действующий как посредник между Citadel и прокси Envoy на узле.
* **Envoy (прокси)**<br>
В процессе работы Envoy обращается к агенту узла, используя локальное соединение, чтобы получить удостоверение и передать его другим сторонам.

## Citadel
Citadel отвечает за приём запросов на идентификацию, их аутентификацию, авторизацию и в конечном счёте выпуск сертификата для данной сущности.<br>

1. Citadel открывает доступ к сервису CA через общедоступный API.<br>
Чтобы запросить идентификацию, абонент соединяется с сервисом CA и посылает запрос CSR в Citadel, который преобразуется в X509 SVID;<br>
2. После получения запроса он передаётся **аутентификатору** для проверки. Метод аутентификации зависит от способа развёртывания Citadel.<br>
Например, в Kubernetes компонент Pilot присваивает каждой рабочей нагрузке имя её сервиса;<br>
3. После аутентификации запроса авторизатор определяет имеет ли право запрашивать удостоверение аутентифицированная сущность. Авторизатор консультируется с реестром идентификаций **(Identity Registry)**, отображающим рабочие нагрузки через их аутентифицированные сущности в идентификационные данные;<br>
4. Как только приложение будет авторизовано на получение удостоверения, производится его выпуск методом подписания сертификата.<br>
Авторизатор запрашивает у эмитента (issuer) создание сертификата и делает его доступным для запрашивающей стороны.<br>
В настоящее время в Citadel в роли эмитентов могут использоваться центры сертификации (CA), действующие в оперативной памяти, и HashiCorp Vault.<br>

## Агенты узлов
Агент узла хранит в памяти секреты, полученные от Citadel, и когда срок их действия подходит к концу (например, осталось 25% времени жизни), агент связывается с Citadel и пытается обновить сертификат.<br>
Также для поддержания масштабируемости Citadel применено архитектурное решение, обязывающее приложения взаимодействовать с локальным агентом узла, а агент узла - с Citadel.<br>
Такой дизайн ограничивает количество подключений к экземплярам Citadel в системе количеством узлов в сетке, а не количеством рабочих нагрузок.<br>
